# MLSpace

## Deployment Prerequisites

### Software
In order to build and deploy MLSpace to your AWS account you will need the following software installed on your machine:
- [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
- [awscli](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
- [nodejs](https://nodejs.org/en/download/) 18+
- [docker](https://docker.com) or a compatible runtime for generating lambda layers
- cdk (`npm install -g cdk`)


### Additional Information
In addition to the required software you will also need to have the following information:
- AWS account Id and region you'll be deploying MLSpace into (you'll need admin credentials or similar)
- IdP information including the OIDC endpoint and client name

### Configure deployment parameters
Update the values in `lib/constants.ts` based on your specific deployment needs. Some of these will directly impact whether new resources are created within your account or whether existing resources (VPC, KMS, Roles, etc) will be leveraged.

| Variable   |      Description      |  Default |
|----------|:-------------:|------:|
| AWS_ACCOUNT | The account number that MLSpace is being deployed into. Used to disambiguated S3 buckets within a region. | - |
| AWS_REGION | The region that MLSpace is being deployed into. This is only needed when you are using an existing VPC or KMS key and `EXISTING_KMS_MASTER_KEY_ARN` or `EXISTING_VPC_ID` is set. | - |
| IDP_ENDPOINT_SSM_PARAM | If set, MLSpace will use the value of this parameter as the `OIDC_URL`. During deployment the value of this parameter will be read from SSM. This value takes precedence over `OIDC_URL` if both are set. | - |
| OIDC_URL | The OIDC endpoint that will be used for MLSpace authentication | - |
| OIDC_CLIENT_NAME | The OIDC client name that should be used by MLSpace for authentication | - |
| OIDC_REDIRECT_URL | The redirect URL that should be used after succesfully authenticating with the OIDC provider. This will default to the API gateway URL generated by the CDK deployment but can be manually set if you're using custom DNS | `undefined` |
| OIDC_VERIFY_SSL | Whether or not calls to the OIDC endpoint specified in the `OIDC_URL` environment variable should validate the server certificate | `true` |
| OIDC_VERIFY_SIGNATURE | Whether or not the lambda authorizer should verify the JWT token signature | `true` |
| ADDITIONAL_LAMBDA_ENVIRONMENT_VARS | A map of key value pairs which will be set as environment variables on every MLSpace lambda | `{}` |
| SYSTEM_BANNER_TEXT | The text to display on the system banner displayed at the top and bottom of the MLSpace web application. If set to a blank string no banner will be displayed. | `` |
| SYSTEM_BANNER_BACKGROUND_COLOR | The background color of the system banner if enabled. Supports valid CSS colors including predefined color names, hex values, and rgb values. | `black` |
| SYSTEM_BANNER_TEXT_COLOR | The color of the text displayed in the system banner if enabled. Supports valid CSS colors including predefined color names, hex values, and rgb values. | `white` |
| RESOURCE_TERMINATION_INTERVAL | Interval (in minutes) to run the resource termination cleanup lambda | `60` |
| DATASETS_TABLE_NAME |  Dynamo DB table to hold dataset related metadata | `mlspace-datasets` |
| PROJECTS_TABLE_NAME |  Dynamo DB table to hold project related metadata | `mlspace-projects` |
| PROJECT_USERS_TABLE_NAME |  Dynamo DB table to hold project membership related metadata. Including permissions and project/user specific IAM role data. | `mlspace-project-users` |
| USERS_TABLE_NAME |  Dynamo DB table to hold user related metadata | `mlspace-users` |
| CONFIG_BUCKET_NAME |  S3 bucket used to store MLSpace configuration files (notebook lifecycle configs, notebook params, etc) | `mlspace-config` |
| DATA_BUCKET_NAME |  S3 bucket used to store user uploaded dataset files | `mlspace-datasets` |
| LOGS_BUCKET_NAME |  S3 bucket used to store logs from EMR clusters launched in MLSpace and, if configured, MLSpace cloudtrail events  | `mlspace-logs` |
| ACCESS_LOGS_BUCKET_NAME | S3 bucket which will store access logs if `ENABLE_ACCESS_LOGGING` is `true` | `mlspace-access-logs` |
| WEBSITE_BUCKET_NAME |  S3 bucket used to store the static MLSpace website  | `mlspace-website` |
| MLSPACE_LIFECYCLE_CONFIG_NAME |  Name of the default licycle config that should be used with MLSpace notebooks (will be generated as part of the CDK deployment)  | `mlspace-notebook-lifecycle-config` |
| NOTEBOOK_PARAMETERS_FILE_NAME |  Filename of the default notebook parameters that is generated as part of the CDK deployment  | `mlspace-website` |
| PERMISSIONS_BOUNDARY_POLICY_NAME | Name of the managed policy used as a permissions boundary for dynamically created MLSpace roles. If this is not set the default permissions boundary will be created and used | - |
| KEY_MANAGER_ROLE_NAME | Name of the IAM role with permissions to manage the KMS Key. If this property is set you _do not_ need to set `EXISTING_KMS_MASTER_KEY_ARN`. | - |
| EXISTING_KMS_MASTER_KEY_ARN | ARN of existing KMS key to use with MLSpace. This key should allow the roles associated with the `NOTEBOOK_ROLE_ARN` and `APP_ROLE_ARN` usage of the key. This value takes precedence over `KEY_MANAGER_ROLE_NAME` if both are set. If this property is set you _do not_ need to set `KEY_MANAGER_ROLE_NAME`. |
| SYSTEM_TAG | Tag which will be applied to all MLSpace resources created with the AWS account to which MLSpace is deployed | `MLSpace` |
| IAM_RESOURCE_PREFIX | Value preprended to MLSpace dynamic roles and policies when `MANAGE_IAM_ROLES` is set to `true` | `MLSpace` |
| MANAGE_IAM_ROLES | This setting determines whether or not MLSpace will dynamically create unique roles per project/user combinations. | `true` |
| NOTIFICATION_DISTRO | Optional email distribution list which will be notified when <TBD> | - |
| EXISTING_VPC_NAME | If MLSpace is being deployed into an existing VPC this should be the name of that VPC (must also set `EXISTING_VPC_ID`) | - |
| EXISTING_VPC_ID | If MLSpace is being deployed into an existing VPC this should be the id of that VPC (must also set `EXISTING_VPC_NAME`) | - |
| EXISTING_VPC_DEFAULT_SECURITY_GROUP | If MLSpace is being deployed into an existing VPC this should be the default security group of that VPC | - |
| APP_ROLE_ARN | Arn of an existing IAM role to use for executing the MLSpace lambdas. This value must be set to an existing role because the default CDK deployment will not create one. | - |
| NOTEBOOK_ROLE_ARN | Arn of an existing IAM role to associate with all notebooks created in MLSpace. If using dynamic roles based on project/user combinations the specific combination role will be used instaed. This value must be set to an existing role because the default CDK deployment will not create one. | - |
| S3_READER_ROLE_ARN | Arn of an existing IAM role to use for reading from the static website S3 bucket. If not specified a new role with the correct privileges will be created | - |
| EMR_DEFAULT_ROLE_ARN | Role that will be used as the "ServiceRole" for all EMR clusters | - |
| EMR_EC2_INSTANCE_ROLE_ARN | Role that will be used as the "JobFlowRole" and "AutoScalingRole" for all EMR clusters | - |
| ENABLE_ACCESS_LOGGING | Whether or not to enable access logging for S3 and APIGW in MLSpace | `true` |
| APIGATEWAY_CLOUDWATCH_ROLE_ARN | If API Gateway access logging is enabled (`ENABLE_ACCESS_LOGGING` is true) then this is the arn of the role that will be used to push those access logs | - |
| CREATE_MLSPACE_CLOUDTRAIL_TRAIL | Whether or not to create an MLSpace trail within the account | `true` |
| NEW_USERS_SUSPENDED | Whether or not new user accounts will be created in a suspended state by default | `false` |
| ENABLE_TRANSLATE | Whether or not translate capabilities will be deployed/enabled in MLSpace. If translate is not available in the region you are deploying to you should set this to `false` | `true` |


### Creating a production optimized web app build
In addition to updating the necessary parameters in the CDK constants file you will also need to create a production build of the web application. You can do this by changing to the web application directory (`frontend/`) and running:
```
# From project root directory
cd frontend
npm run clean && npm install
```
This will generate a production optimized build of the web application and documentation, the resulting artifacts will be written to the `frontend/build/` directory.

There are no web application specific configuration parameters that need to be set as the configuration will be dynamically generated as part of the CDK deployment based on the variables set in `constants.ts` and well as the deployed resources.

## Deploying the CDK application
If you are pre-creating roles you will need to ensure that the required role arns (`APP_ROLE_ARN`, `NOTEBOOK_ROLE_ARN`), role names (`KEY_MANAGER_ROLE_NAME` if `EXISTING_KMS_MASTER_KEY_ARN` is not set), and `AWS_ACCOUNT` (used to ensure unique S3 bucket names) have been properly set in `lib/constants.ts`.

You will also need to set `OIDC_URL` and `OIDC_CLIENT_NAME` with the correct values based on your chosen IdP. These property must be set prior to deploying MLSpace.

The MLSpace application is a standard CDK application and can be deployed just as any CDK application is deployed:
```
# From project root directory
npm install && cdk bootstrap <REPLACE WITH YOUR ACCOUNT NUMBER>/<REPLACE WITH TARGET REGION>
```
Once the account has been bootstrap you can deploy the application. You can optionally include `--require-approval never` in the below command if you don't want to confirm changes:
```
# From project root directory
cdk deploy --all
```
